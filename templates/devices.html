{% extends "base.html" %}
{% block title %}Dispositivos{% endblock %}
{% block extra_css %}
<style>
    .action-buttons {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        white-space: nowrap;
    }
</style>
{% endblock %}
{% block content %}

<div class="card">
    <h2>Gerenciar Dispositivos</h2>
    <div class="d-flex justify-content-start align-items-center gap-2 flex-wrap">
        <button class="btn btn-success" onclick="showModal('addDeviceModal')">‚ûï Adicionar Novo Dispositivo</button>
        <button class="btn btn-primary" onclick="showModal('manageProvedoresModal')" style="margin-left: 10px;">üè¢
            Adicionar Provedor</button>
    </div>
</div>
<div class="card">
    <h2>Lista de Dispositivos</h2>
    {% if devices %}
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>IP</th>
                <th>Tipo</th>
                <th>Protocolo</th>
                <th>Porta</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td>{{ device.name }}</td>
                <td>{{ device.ip_address }}</td>
                <td>{{ device.device_type }}</td>
                <td>{{ device.protocol|upper }}</td>
                <td>{{ device.port }}</td>
                <td>
                    {% if device.active %}
                    <span class="badge badge-success">Ativo</span>
                    {% else %}
                    <span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="backupDevice({{ device.id }})">üîÑ Backup</button>
                        <button class="btn btn-primary" onclick="editDevice({{ device.id }})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="deleteDevice({{ device.id }})">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum dispositivo cadastrado.</p>
    {% endif %}
</div>

<div id="addDeviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Adicionar Dispositivo</h2>
            <span class="close" onclick="closeModal('addDeviceModal')">&times;</span>
        </div>
        <form id="addDeviceForm">
            <div class="form-group"><label>Nome *</label><input type="text" name="name" required></div>
            <div class="form-group"><label>IP *</label><input type="text" name="ip_address" required></div>

            <!-- Campo Provedor/Cliente -->
            <div class="form-group">
                <label for="provedor">
                    <i class="fas fa-building"></i> Provedor/Cliente
                </label>
                <select name="provedor" id="provedor" required>
                    <option value="Sem_Provedor" selected>Sem_Provedor</option>
                    <!-- Provedores will be loaded dynamically -->
                </select>
                <small style="display: block; margin-top: 5px; color: #666; font-size: 0.85rem;">
                    Selecione um provedor cadastrado ou use "Sem_Provedor"
                </small>
            </div>

            <div class="form-group"><label>Tipo *</label>
                <select name="device_type" required>
                    <option value="">Selecione...</option>
                    <option value="ubiquiti_airos">Ubiquiti</option>
                    <option value="mimosa">Mimosa</option>
                    <option value="intelbras_radio">Intelbras</option>
                    <option value="cisco_ios">Cisco</option>
                    <option value="huawei">Huawei</option>
                    <option value="mikrotik_routeros">MikroTik</option>
                </select>
            </div>
            <div class="form-group"><label>Protocolo *</label>
                <select name="protocol" required>
                    <option value="ssh">SSH</option>
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                </select>
            </div>
            <div class="form-group"><label>Porta</label><input type="number" name="port" value="22"></div>
            <div class="form-group"><label>Usu√°rio *</label><input type="text" name="username" required></div>
            <div class="form-group"><label>Senha *</label><input type="password" name="password" required></div>
            <button type="submit" class="btn btn-success">üíæ Salvar</button>
        </form>
    </div>
</div>

<div id="editDeviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Dispositivo</h2>
            <span class="close" onclick="closeModal('editDeviceModal')">&times;</span>
        </div>
        <form id="editDeviceForm">
            <input type="hidden" id="editId">
            <div class="form-group"><label>Nome *</label><input type="text" id="editName" required></div>
            <div class="form-group"><label>IP *</label><input type="text" id="editIp" required></div>
            <div class="form-group"><label>Protocolo *</label>
                <select id="editProtocol" required>
                    <option value="ssh">SSH</option>
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                </select>
            </div>
            <div class="form-group"><label>Porta</label><input type="number" id="editPort" required></div>
            <button type="submit" class="btn btn-success">üíæ Atualizar</button>
        </form>
    </div>
</div>

<!-- Modal Gerenciar Provedores -->
<div id="manageProvedoresModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2>üè¢ Gerenciar Provedores/Clientes</h2>
            <span class="close" onclick="closeModal('manageProvedoresModal')">&times;</span>
        </div>

        <!-- Formul√°rio para adicionar novo provedor -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">Adicionar Novo Provedor</h3>
            <form id="addProvedorForm" style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>Nome do Provedor/Cliente *</label>
                    <input type="text" id="newProvedorName" required placeholder="Ex: OLLA, SPEEDNET, Cliente_A">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>Descri√ß√£o (opcional)</label>
                    <input type="text" id="newProvedorDescription" placeholder="Descri√ß√£o adicional">
                </div>
                <button type="submit" class="btn btn-success" style="white-space: nowrap;">‚ûï Adicionar</button>
            </form>
        </div>

        <!-- Lista de provedores cadastrados -->
        <div>
            <h3 style="margin-bottom: 10px; font-size: 16px;">Provedores Cadastrados</h3>
            <div id="provedoresList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #999; padding: 20px;">Carregando...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.getElementById('addDeviceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const response = await fetch('/devices/add', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.success) {
                showAlert('Dispositivo adicionado!', 'success');
                closeModal('addDeviceModal');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Erro: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    });

    async function editDevice(id) {
        try {
            const response = await fetch('/devices/' + id + '/get');
            const device = await response.json();
            document.getElementById('editId').value = device.id;
            document.getElementById('editName').value = device.name;
            document.getElementById('editIp').value = device.ip_address;
            document.getElementById('editProtocol').value = device.protocol;
            document.getElementById('editPort').value = device.port;
            showModal('editDeviceModal');
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    }

    document.getElementById('editDeviceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const data = {
            name: document.getElementById('editName').value,
            ip_address: document.getElementById('editIp').value,
            protocol: document.getElementById('editProtocol').value,
            port: document.getElementById('editPort').value
        };
        try {
            const response = await fetch('/devices/' + id + '/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showAlert('Atualizado!', 'success');
                closeModal('editDeviceModal');
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    });

    async function backupDevice(deviceId) {
        if (!confirm('Backup agora?')) return;
        try {
            const response = await fetch('/backup/' + deviceId, { method: 'POST' });
            const data = await response.json();
            if (data.success) showAlert('Backup realizado!', 'success');
            else showAlert('Erro: ' + data.error, 'danger');
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    }

    async function deleteDevice(deviceId) {
        if (!confirm('Remover permanentemente?')) return;
        try {
            const response = await fetch('/devices/' + deviceId + '/delete', { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                showAlert('Removido!', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    }

    // Load provedores into the select dropdown
    function loadProvedoresIntoSelect() {
        const select = document.getElementById('provedor');
        if (!select) return;

        // Keep the first option (Sem_Provedor) and clear the rest
        const firstOption = select.querySelector('option[value="Sem_Provedor"]');
        select.innerHTML = '';
        if (firstOption) {
            select.appendChild(firstOption);
        } else {
            const defaultOption = document.createElement('option');
            defaultOption.value = 'Sem_Provedor';
            defaultOption.textContent = 'Sem_Provedor';
            defaultOption.selected = true;
            select.appendChild(defaultOption);
        }

        fetch("/api/provedores")
            .then(response => response.json())
            .then(data => {
                if (data.provedores && data.provedores.length > 0) {
                    data.provedores.forEach(function (prov) {
                        const option = document.createElement("option");
                        option.value = prov;
                        option.textContent = prov;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao carregar provedores:', error);
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadProvedoresIntoSelect();
    });

    // Provedores Management
    async function loadProvedores() {
        const listDiv = document.getElementById('provedoresList');
        try {
            const response = await fetch('/api/provedores/all');
            const data = await response.json();
            const provedores = data.provedores || [];

            if (provedores.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhum provedor cadastrado ainda.</p>';
                return;
            }

            listDiv.innerHTML = provedores.map(p => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 4px;">
                    <div>
                        <strong>${p.name}</strong>
                        ${p.description ? `<br><small style="color: #666;">${p.description}</small>` : ''}
                    </div>
                    <button class="btn btn-danger" onclick="deleteProvedor(${p.id}, '${p.name.replace(/'/g, "\\'")}')" style="padding: 4px 12px; font-size: 12px;">üóëÔ∏è Remover</button>
                </div>
            `).join('');
        } catch (error) {
            listDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">Erro ao carregar: ${error.message}</p>`;
        }
    }

    document.getElementById('addProvedorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('newProvedorName').value.trim();
        const description = document.getElementById('newProvedorDescription').value.trim() || null;

        if (!name) {
            showAlert('Nome do provedor √© obrigat√≥rio', 'danger');
            return;
        }

        try {
            const response = await fetch('/api/provedores/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });
            const data = await response.json();

            if (data.success) {
                showAlert('Provedor adicionado com sucesso!', 'success');
                document.getElementById('newProvedorName').value = '';
                document.getElementById('newProvedorDescription').value = '';
                loadProvedores();
                loadProvedoresIntoSelect(); // Refresh the select dropdown
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Erro: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    });

    async function deleteProvedor(provedorId, provedorName) {
        if (!confirm(`Tem certeza que deseja remover o provedor "${provedorName}"?\n\nNota: Isso n√£o remove dispositivos associados a este provedor.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/provedores/${provedorId}/delete`, { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                showAlert('Provedor removido!', 'success');
                loadProvedores();
                loadProvedoresIntoSelect(); // Refresh the select dropdown
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Erro: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Erro: ' + error.message, 'danger');
        }
    }

    // Load provedores when modal opens
    const originalShowModal = window.showModal || function (modalId) {
        document.getElementById(modalId).style.display = 'block';
    };

    window.showModal = function (modalId) {
        originalShowModal(modalId);
        if (modalId === 'manageProvedoresModal') {
            loadProvedores();
        } else if (modalId === 'addDeviceModal') {
            // Refresh provedores dropdown when opening add device modal
            loadProvedoresIntoSelect();
        }
    };
</script>
{% endblock %}