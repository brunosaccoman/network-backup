{% extends "base.html" %}
{% block title %}Dispositivos{% endblock %}
{% block extra_css %}
<style>
    .action-buttons {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e0e6ed;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: box-shadow 0.2s;
    }

    .stat-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: white;
    }

    .stat-icon.blue {
        background: #3498db;
    }

    .stat-icon.green {
        background: #27ae60;
    }

    .stat-icon.red {
        background: #e74c3c;
    }

    .stat-icon.orange {
        background: #f39c12;
    }

    .stat-info {
        display: flex;
        flex-direction: column;
        align-items: start;
        justify-content: left;
    }

    .stat-info h3 {
        font-size: 26px;
        font-weight: 700;
        margin: 0;
        color: #2c3e50;
    }

    .stat-info p {
        font-size: 13px;
        color: #7f8c8d;
        margin: 0;
    }

    .table-container {
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e6ed;
        overflow: hidden;
        margin-top: 20px;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid #e0e6ed;
        background: #f9fafb;
    }

    .table-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .table-header-title {
        margin: 0;
    }

    .table-header-subtitle {
        margin: 0;
        font-size: 12px;
        color: #6b7280;
    }

    .table-header-actions {
        margin-left: auto;
    }

    .table-header h5 {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .table-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8f9fa;
    }

    .data-table th {
        padding: 12px 20px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #e0e6ed;
    }

    .data-table th.text-right {
        text-align: right;
    }

    .data-table td {
        padding: 14px 20px;
        font-size: 13px;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table td.text-right {
        text-align: right;
    }

    .data-table tbody tr:hover {
        background: #f8f9fb;
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    .badge-status {
        padding: 4px 10px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-active {
        background: #d1ecf1;
        color: #0c5460;
    }

    .table-footer {
        padding: 15px 25px;
        border-top: 1px solid #e0e6ed;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #7f8c8d;
    }

    .device-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.online {
        background: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }

    .status-dot.offline {
        background: #95a5a6;
    }

    #provedorFilter,
    #backupProvedorFilter {
        min-width: 200px;
    }

    #provedorFilter:focus,
    #backupProvedorFilter:focus,
    #backupIpSearch:focus {
        outline: none;
        border-color: #3498db;
    }

    #backupIpSearch::placeholder {
        color: #999;
    }

    .provedores-wrapper {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .provedor-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        background: white;
        gap: 12px;
        transition: box-shadow 0.2s, border-color 0.2s;
    }

    .provedor-item:hover {
        border-color: #3498db;
        box-shadow: 0 2px 6px rgba(52, 152, 219, 0.15);
    }

    .provedor-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .provedor-info strong {
        font-size: 0.95rem;
        color: #1f2937;
    }

    .provedor-info span {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .provedor-actions {
        display: inline-flex;
        gap: 8px;
        align-items: center;
    }

    .search-input {
        padding: 6px 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 200px;
    }

    .action-buttons-end {
        justify-content: flex-end;
    }

    .modal-content-large {
        max-width: 700px;
    }

    .provedor-form-container {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .provedor-form-container h3 {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .provedor-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .form-group-flex {
        flex: 1;
        margin-bottom: 0;
    }

    .btn-nowrap {
        white-space: nowrap;
    }

    .provedores-section h3 {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .provedores-loading {
        text-align: center;
        color: #999;
        padding: 20px;
    }

    .modal-body-center {
        text-align: center;
        padding: 20px;
    }

    .loading-spinner {
        font-size: 40px;
        color: #007bff;
    }

    .loading-text {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const closeManageProvedoresModal = document.getElementById('closeManageProvedoresModal');
        if (closeManageProvedoresModal) {
            closeManageProvedoresModal.addEventListener('click', function () {
                closeModal('manageProvedoresModal');
            });
        }

        const closeAddDeviceModal = document.getElementById('closeAddDeviceModal');
        if (closeAddDeviceModal) {
            closeAddDeviceModal.addEventListener('click', function () {
                closeModal('addDeviceModal');
            });
        }

        const closeEditDeviceModal = document.getElementById('closeEditDeviceModal');
        if (closeEditDeviceModal) {
            closeEditDeviceModal.addEventListener('click', function () {
                closeModal('editModal');
            });
        }

        const searchInput = document.getElementById('deviceSearch');
        if (!searchInput) {
            console.error('Elemento de busca não encontrado!');
            return;
        }

        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            let visibleCount = 0;
            const tableBody = document.getElementById('devicesTableBody');

            if (!tableBody) {
                console.error('Tabela de dispositivos não encontrada!');
                return;
            }

            Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
                const deviceName = row.querySelector('td:nth-child(1) strong') ? row.querySelector('td:nth-child(1) strong').innerText.toLowerCase() : '';
                const deviceIp = row.querySelector('td:nth-child(2)') ? row.querySelector('td:nth-child(2)').innerText.toLowerCase() : '';
                const deviceProvedor = row.querySelector('td:nth-child(3)') ? row.querySelector('td:nth-child(3)').innerText.toLowerCase() : '';
                const devicePlatform = row.querySelector('td:nth-child(4)') ? row.querySelector('td:nth-child(4)').innerText.toLowerCase() : '';
                const deviceProtocol = row.querySelector('td:nth-child(5)') ? row.querySelector('td:nth-child(5)').innerText.toLowerCase() : '';
                const devicePort = row.querySelector('td:nth-child(6)') ? row.querySelector('td:nth-child(6)').innerText.toLowerCase() : '';

                const text = deviceName + ' ' + deviceIp + ' ' + deviceProvedor + ' ' + devicePlatform + ' ' + deviceProtocol + ' ' + devicePort;

                if (text.includes(query)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            console.log("Dispositivos visíveis:", visibleCount);
            document.getElementById('visibleCount').innerText = visibleCount;
        });

        document.getElementById('addDeviceForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/devices/add', {
                    method: 'POST',
                    body: new URLSearchParams(data)
                });
                const result = await response.json();

                if (result.success) {
                    alert('Dispositivo adicionado com sucesso!');
                    this.reset();
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao adicionar dispositivo');
            }
        });

        async function editDevice(deviceId) {
            try {
                const response = await fetch(`/devices/${deviceId}/get`);
                const device = await response.json();

                document.getElementById('editId').value = device.id;
                document.getElementById('editName').value = device.name;
                document.getElementById('editIp').value = device.ip_address;
                document.getElementById('editProtocol').value = device.protocol;
                document.getElementById('editPort').value = device.port;
                document.getElementById('editProvedor').value = device.provedor || '';

                showModal('editModal');
            } catch (error) {
                showAlert('Erro: ' + error.message, 'danger');
            }
        }

        function updateDeviceRowInTable(deviceId, updatedData) {
            const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (!row) return;

            if (updatedData.name !== undefined) {
                const nameElement = row.querySelector('.device-name');
                if (nameElement) nameElement.textContent = updatedData.name;
            }

            if (updatedData.ip_address !== undefined) {
                const ipElement = row.querySelector('.device-ip');
                if (ipElement) ipElement.textContent = updatedData.ip_address;
            }

            if (updatedData.provedor !== undefined) {
                const provedorValue = updatedData.provedor || 'Sem_Provedor';
                const provedorElement = row.querySelector('.device-provedor');
                if (provedorElement) provedorElement.textContent = provedorValue;
                row.setAttribute('data-provedor', provedorValue);
            }

            if (updatedData.protocol !== undefined) {
                const protocolElement = row.querySelector('.device-protocol');
                if (protocolElement) protocolElement.textContent = updatedData.protocol.toUpperCase();
            }

            if (updatedData.port !== undefined) {
                const portElement = row.querySelector('.device-port');
                if (portElement) portElement.textContent = updatedData.port;
            }
        }

        async function saveEdit(event) {
            console.log('Iniciando a função saveEdit...');
            const deviceId = document.getElementById('editId').value;
            const deviceName = document.getElementById('editName').value;
            const deviceIp = document.getElementById('editIp').value;
            const deviceProtocol = document.getElementById('editProtocol').value;
            const devicePort = document.getElementById('editPort').value;
            const deviceProvedor = document.getElementById('editProvedor').value;

            console.log('Valores coletados para salvar:');
            console.log('ID:', deviceId);
            console.log('Nome:', deviceName);
            console.log('IP:', deviceIp);
            console.log('Protocolo:', deviceProtocol);
            console.log('Porta:', devicePort);
            console.log('Provedor:', deviceProvedor);

            const deviceData = {
                id: deviceId,
                name: deviceName,
                ip_address: deviceIp,
                protocol: deviceProtocol,
                port: devicePort,
                provedor: deviceProvedor
            };

            console.log('Objeto para enviar:', deviceData);

            try {
                console.log('Enviando requisição para atualizar dispositivo...');
                const response = await fetch('/devices/' + deviceId + '/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deviceData)
                });

                console.log('Status da resposta:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Resposta do servidor:', data);

                    if (data.success) {
                        showAlert('Dispositivo atualizado com sucesso!', 'success');
                        updateDeviceRowInTable(deviceId, deviceData);
                        closeModal('editModal');
                    } else {
                        showAlert('Erro: ' + data.error, 'danger');
                    }
                } else {
                    console.log('Erro: resposta do servidor com falha');
                    showAlert('Erro ao salvar dispositivo, tente novamente.', 'danger');
                }
            } catch (error) {
                console.log('Erro na requisição:', error);
                showAlert('Erro: ' + error.message, 'danger');
            }
        }

        async function backupDevice(deviceId) {
            event.preventDefault();
            if (!confirm('Backup agora?')) return;
            try {
                const response = await fetch('/backup/' + deviceId, { method: 'POST' });
                const data = await response.json();
                if (data.success) showAlert('Backup realizado!', 'success');
                else showAlert('Erro: ' + data.error, 'danger');
            } catch (error) {
                showAlert('Erro: ' + error.message, 'danger');
            }
        }

        async function deleteDevice(deviceId) {
            console.log('Delete device', deviceId);
            if (!confirm('Deletar este dispositivo?')) return;
            try {
                const response = await fetch('/devices/' + deviceId + '/delete', { method: 'POST' });
                const data = await response.json();
                if (data.success) showAlert('Dispositivo deletado!', 'success');
                else showAlert('Erro: ' + data.error, 'danger');
            } catch (error) {
                showAlert('Erro: ' + error.message, 'danger');
            }
        }

        document.querySelectorAll('.editButton').forEach(button => {
            button.addEventListener('click', function () {
                const deviceId = this.getAttribute('data-device-id');
                editDevice(deviceId);
            });
        });

        document.querySelectorAll('.backupButton').forEach(button => {
            button.addEventListener('click', function () {
                const deviceId = this.getAttribute('data-device-id');
                backupDevice(deviceId);
            });
        });

        document.querySelectorAll('.deleteButton').forEach(button => {
            button.addEventListener('click', function () {
                const deviceId = this.getAttribute('data-device-id');
                deleteDevice(deviceId);
            });
        })

        async function loadProvedores() {
            const provedoresList = document.getElementById('provedoresList');
            if (!provedoresList) return;

            try {
                const response = await fetch('/api/provedores/all');
                if (!response.ok) throw new Error('Falha ao carregar provedores');
                const data = await response.json();
                const provedores = Array.isArray(data?.provedores) ? data.provedores : [];

                provedoresList.innerHTML = '';

                if (!provedores.length) {
                    provedoresList.innerHTML = '<p>Sem provedores cadastrados.</p>';
                    return;
                }

                provedores.forEach(provedor => {
                    const id = typeof provedor === 'object' ? provedor?.id : undefined;
                    const name = typeof provedor === 'string' ? provedor : provedor?.name;
                    const description = typeof provedor === 'object' ? provedor?.description : undefined;
                    if (!name) return;

                    const item = document.createElement('div');
                    item.classList.add('provedor-item');

                    const info = document.createElement('div');
                    info.classList.add('provedor-info');
                    info.innerHTML = `<strong>${name}</strong>${description ? `<span>${description}</span>` : ''}`;

                    const actions = document.createElement('div');
                    actions.classList.add('provedor-actions');

                    if (id) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.classList.add('btn-action', 'danger');
                        deleteBtn.title = `Remover ${name}`;
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.addEventListener('click', () => deleteProvedor(id, name));
                        actions.appendChild(deleteBtn);
                    }

                    item.appendChild(info);
                    item.appendChild(actions);
                    provedoresList.appendChild(item);
                });
            } catch (error) {
                console.error('Erro ao carregar provedores:', error);
                provedoresList.innerHTML = '<p>Erro ao carregar provedores.</p>';
            }
        }

        async function loadProvedoresIntoSelect() {
            const selectElement = document.getElementById('provedor');
            if (!selectElement) return;

            try {
                const response = await fetch('/api/provedores');
                if (!response.ok) throw new Error('Falha ao carregar provedores');
                const data = await response.json();
                const provedores = Array.isArray(data?.provedores) ? data.provedores : [];

                selectElement.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = 'Sem_Provedor';
                defaultOption.textContent = 'Sem_Provedor';
                selectElement.appendChild(defaultOption);

                if (provedores.length) {
                    provedores.forEach(provedor => {
                        const name = typeof provedor === 'string' ? provedor : provedor?.name;
                        if (!name) return;
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    });
                } else {
                    const emptyOption = document.createElement('option');
                    emptyOption.disabled = true;
                    emptyOption.textContent = 'Sem provedores cadastrados.';
                    selectElement.appendChild(emptyOption);
                }
            } catch (error) {
                console.error('Erro ao carregar provedores:', error);
                const errorOption = document.createElement('option');
                errorOption.disabled = true;
                errorOption.textContent = 'Erro ao carregar provedores.';
                selectElement.appendChild(errorOption);
            }
        }

        window.showModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'block';

            if (modalId === 'manageProvedoresModal') {
                loadProvedores();
            } else if (modalId === 'addDeviceModal') {
                loadProvedoresIntoSelect();
            }
        };

        function closeModal(modalId, event) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('alert', `alert-${type}`);
            alertDiv.innerText = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        async function deleteProvedor(id, name) {
            if (!confirm(`Remover o provedor "${name}"?`)) return;

            try {
                const response = await fetch(`/api/provedores/${id}/delete`, {
                    method: 'POST'
                });
                const result = await response.json().catch(() => ({}));

                if (response.ok && result.success !== false) {
                    showAlert(`Provedor "${name}" removido.`, 'success');
                    await loadProvedores();
                    await loadProvedoresIntoSelect();
                } else {
                    const errorMessage = result?.error || 'Não foi possível remover o provedor.';
                    showAlert(`Erro: ${errorMessage}`, 'danger');
                }
            } catch (error) {
                console.error('Erro ao remover provedor:', error);
                showAlert('Erro ao remover provedor: ' + error.message, 'danger');
            }
        }

        const addProvedorForm = document.getElementById('addProvedorForm');
        if (addProvedorForm) {
            addProvedorForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const nameInput = document.getElementById('newProvedorName');
                const descriptionInput = document.getElementById('newProvedorDescription');

                const name = nameInput?.value.trim();
                const description = descriptionInput?.value.trim();

                if (!name) {
                    showAlert('Informe o nome do provedor.', 'danger');
                    return;
                }

                try {
                    const response = await fetch('/api/provedores/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            description: description || null
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showAlert('Provedor adicionado com sucesso!', 'success');
                        addProvedorForm.reset();
                        await loadProvedores();
                        await loadProvedoresIntoSelect();
                    } else {
                        const errorMessage = result?.error || 'Não foi possível adicionar o provedor.';
                        showAlert(`Erro: ${errorMessage}`, 'danger');
                    }
                } catch (error) {
                    console.error('Erro ao adicionar provedor:', error);
                    showAlert('Erro ao adicionar provedor: ' + error.message, 'danger');
                }
            });
        }

        const saveEditButton = document.getElementById('saveEditButton');
        if (saveEditButton) {
            saveEditButton.addEventListener('click', function (event) {
                event.preventDefault();
                console.log("Botão de salvar clicado!");
                saveEdit(event);
            });
        }

        const editDeviceForm = document.getElementById('editDeviceForm');
        if (!editDeviceForm) {
            console.error('Formulário de edição não encontrado!');
            return;
        }

        editDeviceForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const deviceId = document.getElementById('editId').value;
            const deviceName = document.getElementById('editName').value;
            const deviceIp = document.getElementById('editIp').value;
            const deviceProtocol = document.getElementById('editProtocol').value;
            const devicePort = document.getElementById('editPort').value;
            const deviceProvedor = document.getElementById('editProvedor').value;

            console.log('Valores coletados para salvar:');
            console.log('ID:', deviceId);
            console.log('Nome:', deviceName);
            console.log('IP:', deviceIp);
            console.log('Protocolo:', deviceProtocol);
            console.log('Porta:', devicePort);
            console.log('Provedor:', deviceProvedor);

            const deviceData = {
                id: deviceId,
                name: deviceName,
                ip_address: deviceIp,
                protocol: deviceProtocol,
                port: devicePort,
                provedor: deviceProvedor
            };

            console.log('Objeto para enviar:', deviceData);

            try {
                console.log('Enviando requisição para atualizar dispositivo...');
                const response = await fetch('/devices/' + deviceId + '/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deviceData)
                });

                console.log('Status da resposta:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Resposta do servidor:', data);

                    if (data.success) {
                        showAlert('Dispositivo atualizado com sucesso!', 'success');
                        updateDeviceRowInTable(deviceId, deviceData);
                        closeModal('editModal');
                    } else {
                        showAlert('Erro: ' + data.error, 'danger');
                    }
                } else {
                    console.log('Erro: resposta do servidor com falha');
                    showAlert('Erro ao salvar dispositivo, tente novamente.', 'danger');
                }
            } catch (error) {
                console.log('Erro na requisição:', error);
                showAlert('Erro: ' + error.message, 'danger');
            }
        });

        function applyProvedorFilter() {
            const provedorFilter = document.getElementById('deviceProvedorFilter');
            if (!provedorFilter) return;

            const selectedProvedor = provedorFilter.value.toLowerCase();
            const tableBody = document.getElementById('devicesTableBody');
            if (!tableBody) return;

            let visibleCount = 0;
            Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
                const provedorValue = row.getAttribute('data-provedor') || 'Sem_Provedor';
                const provedorMatch = !selectedProvedor ||
                    provedorValue.toLowerCase() === selectedProvedor.toLowerCase() ||
                    (selectedProvedor === '' && provedorValue);

                if (provedorMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('visibleCount').innerText = visibleCount;
        }

        const provedorFilterElement = document.getElementById('deviceProvedorFilter');
        if (provedorFilterElement) {
            provedorFilterElement.addEventListener('change', function () {
                applyProvedorFilter();
                const searchInput = document.getElementById('deviceSearch');
                if (searchInput && searchInput.value) {
                    searchInput.dispatchEvent(new Event('input'));
                }
            });
        }

        const originalSearchHandler = searchInput?.oninput;
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const query = this.value.toLowerCase();
                const provedorFilter = document.getElementById('deviceProvedorFilter');
                const selectedProvedor = provedorFilter ? provedorFilter.value.toLowerCase() : '';
                let visibleCount = 0;
                const tableBody = document.getElementById('devicesTableBody');

                if (!tableBody) {
                    console.error('Tabela de dispositivos não encontrada!');
                    return;
                }

                Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
                    const deviceName = row.querySelector('td:nth-child(1) strong') ? row.querySelector('td:nth-child(1) strong').innerText.toLowerCase() : '';
                    const deviceIp = row.querySelector('td:nth-child(2)') ? row.querySelector('td:nth-child(2)').innerText.toLowerCase() : '';
                    const deviceProvedor = row.querySelector('td:nth-child(3)') ? row.querySelector('td:nth-child(3)').innerText.toLowerCase() : '';
                    const devicePlatform = row.querySelector('td:nth-child(4)') ? row.querySelector('td:nth-child(4)').innerText.toLowerCase() : '';
                    const deviceProtocol = row.querySelector('td:nth-child(5)') ? row.querySelector('td:nth-child(5)').innerText.toLowerCase() : '';
                    const devicePort = row.querySelector('td:nth-child(6)') ? row.querySelector('td:nth-child(6)').innerText.toLowerCase() : '';

                    const text = deviceName + ' ' + deviceIp + ' ' + deviceProvedor + ' ' + devicePlatform + ' ' + deviceProtocol + ' ' + devicePort;
                    const provedorValue = row.getAttribute('data-provedor') || 'Sem_Provedor';
                    const provedorMatch = !selectedProvedor ||
                        provedorValue.toLowerCase() === selectedProvedor.toLowerCase();

                    if (text.includes(query) && provedorMatch) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                console.log("Dispositivos visíveis:", visibleCount);
                document.getElementById('visibleCount').innerText = visibleCount;
            });
        }

    });
</script>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="table-header">
        <div class="table-header-content">
            <div>
                <h5 class="table-header-title"><i class="fas fa-server"></i> Dispositivos Monitorados</h5>
                <p class="table-header-subtitle">Gerencie dispositivos e provedores em um só lugar</p>
            </div>
        </div>
        <div class="table-actions">
            {% set filter_id = 'device' %}
            {% set show_provedor_filter = true %}
            {% set show_ip_search = false %}
            {% include 'components/table_filters.html' %}
            <input id="deviceSearch" type="text" placeholder="Buscar dispositivo..." class="search-input">
            <div class="table-header-actions">
                <button class="btn-gerenciar btn-gerenciar--ghost" onclick="showModal('manageProvedoresModal')">
                    <i class="fas fa-building"></i> Adicionar Provedor
                </button>
                <button class="btn-gerenciar btn-gerenciar--primary" onclick="showModal('addDeviceModal')">
                    <i class="fas fa-plus"></i> Novo Dispositivo
                </button>
            </div>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Endereço IP</th>
                <th>Provedor/Cliente</th>
                <th>Plataforma</th>
                <th>Protocolo</th>
                <th>Porta</th>
                <th>Status</th>
                <th class="text-right">Ações</th>
            </tr>
        </thead>
        <tbody id="devicesTableBody">
            {% for device in devices %}
            <tr data-device-id="{{ device.id }}"
                data-provedor="{{ device.provedor if device.provedor else 'Sem_Provedor' }}">
                <td>
                    <div class="device-status">
                        <span class="status-dot {{ 'online' if device.active else 'offline' }}"></span>
                        <strong class="device-name">{{ device.name }}</strong>
                    </div>
                </td>
                <td class="device-ip">{{ device.ip_address }}</td>
                <td class="device-provedor">{{ device.provedor if device.provedor else 'Sem_Provedor' }}</td>
                <td class="device-type">{{ device.device_type|title }}</td>
                <td class="device-protocol">{{ device.protocol|upper }}</td>
                <td class="device-port">{{ device.port }}</td>
                <td>
                    <span class="badge-status badge-{{ 'active' if device.active else 'failed' }}">
                        {{ 'Ativo' if device.active else 'Inativo' }}
                    </span>
                </td>
                <td class="text-right">
                    <div class="action-buttons action-buttons-end">
                        <button class="btn-action backupButton" data-device-id="{{ device.id }}" title="Fazer Backup">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="btn-action editButton" data-device-id="{{ device.id }}" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action deleteButton" data-device-id="{{ device.id }}" title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="table-footer">
        <div id="deviceCount">Mostrando <span id="visibleCount">{{ devices|length }}</span> de {{ devices|length }}
            dispositivos</div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5>Editar Dispositivo</h5>
            <span class="close" onclick="closeModal('editModal')">&times;</span>
        </div>
        <form id="editDeviceForm">
            <input type="hidden" id="editId">
            <div class="form-group"><label>Nome</label><input type="text" id="editName" class="form-control"></div>
            <div class="form-group"><label>Endereço IP</label><input type="text" id="editIp" class="form-control"></div>
            <div class="form-group">
                <label>Protocolo</label>
                <select id="editProtocol" class="form-control">
                    <option value="ssh">SSH</option>
                    <option value="ftp">FTP</option>
                    <option value="sftp">SFTP</option>
                </select>
            </div>
            <div class="form-group"><label>Porta</label><input type="number" id="editPort" class="form-control"></div>
            <div class="form-group">
                <label for="editProvedor">Provedor</label>
                <select id="editProvedor" class="form-control">
                    <option value="">Todos</option>
                    {% for prov in provedores %}
                    <option value="{{ prov }}">{{ prov }}</option>
                    {% endfor %}
                </select>
            </div>
            <button id="saveEditButton" class="btn-gerenciar btn-gerenciar--primary" type="submit">
                <i class="fas fa-save"></i> Salvar
            </button>
        </form>
    </div>
</div>

<div id="addDeviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Adicionar Dispositivo</h2>
            <span class="close" onclick="closeModal('addDeviceModal')">&times;</span>
        </div>
        <form id="addDeviceForm">
            <div class="form-group"><label>Nome *</label><input type="text" name="name" required></div>
            <div class="form-group"><label>IP *</label><input type="text" name="ip_address" required></div>
            <div class="form-group">
                <label for="provedor">Provedor/Cliente</label>
                <select name="provedor" id="provedor" required>
                    <option value="Sem_Provedor" selected>Sem_Provedor</option>
                </select>
                <small>Selecione um provedor cadastrado ou use "Sem_Provedor"</small>
            </div>
            <div class="form-group">
                <label>Tipo *</label>
                <select name="device_type" required>
                    <option value="">Selecione...</option>
                    <option value="ubiquiti_airos">Ubiquiti</option>
                    <option value="mimosa">Mimosa</option>
                    <option value="intelbras_radio">Intelbras</option>
                    <option value="cisco_ios">Cisco</option>
                    <option value="huawei">Huawei</option>
                    <option value="mikrotik_routeros">MikroTik</option>
                </select>
            </div>
            <div class="form-group">
                <label>Protocolo *</label>
                <select name="protocol" required>
                    <option value="ssh">SSH</option>
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                </select>
            </div>
            <div class="form-group"><label>Porta</label><input type="number" name="port" value="22"></div>
            <div class="form-group"><label>Usuário *</label><input type="text" name="username" required></div>
            <div class="form-group"><label>Senha *</label><input type="password" name="password" required
                    autocomplete="current-password"></div>
            <button type="submit" class="btn-gerenciar btn-gerenciar--primary">
                <i class="fas fa-save"></i> Salvar
            </button>
        </form>
    </div>
</div>

<div id="manageProvedoresModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2><i class="fas fa-building"></i> Gerenciar Provedores/Clientes</h2>
            <span class="close" onclick="closeModal('manageProvedoresModal')">&times;</span>
        </div>

        <div class="provedor-form-container">
            <h3>Adicionar Novo Provedor</h3>
            <form id="addProvedorForm" class="provedor-form">
                <div class="form-group form-group-flex">
                    <label>Nome do Provedor/Cliente *</label>
                    <input type="text" id="newProvedorName" required placeholder="Ex: OLLA, SPEEDNET, Cliente_A">
                </div>
                <div class="form-group form-group-flex">
                    <label>Descrição (opcional)</label>
                    <input type="text" id="newProvedorDescription" placeholder="Descrição adicional">
                </div>
                <button type="submit" class="btn-gerenciar btn-gerenciar--primary btn-nowrap">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </form>
        </div>

        <div>
            <h3 class="provedores-section">Provedores Cadastrados</h3>
            <div id="provedoresList" class="provedores-wrapper">
                <p class="provedores-loading">Carregando...</p>
            </div>
        </div>
    </div>
</div>

<div id="deleteProvedorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-triangle-exclamation"></i> Excluir Provedor</h2>
            <span class="close" onclick="closeModal('deleteProvedorModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>Você tem certeza de que deseja excluir este provedor? Esta ação não pode ser desfeita.</p>
            <button class="btn-gerenciar btn-gerenciar--danger" id="confirmDeleteProvedorBtn">Excluir</button>
            <button class="btn-gerenciar btn-gerenciar--ghost"
                onclick="closeModal('deleteProvedorModal')">Cancelar</button>
        </div>
    </div>
</div>

<div id="loadingModal" class="modal">
    <div class="modal-content">
        <div class="modal-body modal-body-center">
            <i class="fas fa-spinner fa-spin loading-spinner"></i>
            <p class="loading-text">Carregando...</p>
        </div>
    </div>
</div>
{% endblock %}