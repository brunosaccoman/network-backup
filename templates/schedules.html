{% extends "base.html" %}
{% block title %}Agendamentos{% endblock %}
{% block extra_css %}
<style>
.action-buttons { display: flex; gap: 0.3rem; }
.action-buttons .btn { padding: 0.5rem 0.8rem; font-size: 0.85rem; }
</style>
{% endblock %}
{% block content %}
<div class="card">
    <h2>Agendamentos</h2>
    <button class="btn btn-success" onclick="showModal('addScheduleModal')">üìÖ Criar Agendamento</button>
</div>

<div class="card">
    <h2>Agendamentos Ativos</h2>
    {% if schedules %}
    <table>
        <thead>
            <tr><th>ID</th><th>Dispositivo</th><th>Frequ√™ncia</th><th>Hor√°rio</th><th>Status</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody>
            {% for schedule in schedules %}
            <tr>
                <td>{{ schedule.id }}</td>
                <td>{{ schedule.device_name or 'Todos os dispositivos' }}</td>
                <td>
                    {% if schedule.frequency == 'daily' %}Di√°rio{% endif %}
                    {% if schedule.frequency == 'weekly' %}Semanal{% endif %}
                    {% if schedule.frequency == 'monthly' %}Mensal{% endif %}
                </td>
                <td>{{ schedule.time }}</td>
                <td>
                    {% if schedule.active %}
                    <span class="badge badge-success">Ativo</span>
                    {% else %}
                    <span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="editSchedule({{ schedule.id }})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="deleteSchedule({{ schedule.id }})">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum agendamento configurado.</p>
    {% endif %}
</div>

<!-- Modal Adicionar -->
<div id="addScheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Criar Agendamento</h2>
            <span class="close" onclick="closeModal('addScheduleModal')">&times;</span>
        </div>
        <form id="addScheduleForm">
            <div class="form-group">
                <label>Dispositivo</label>
                <select name="device_id">
                    <option value="">Todos os dispositivos</option>
                    {% for device in devices %}
                    {% if device.active %}
                    <option value="{{ device.id }}">{{ device.name }} ({{ device.ip_address }})</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Frequ√™ncia *</label>
                <select name="frequency" required id="frequency" onchange="updateFrequency()">
                    <option value="">Selecione...</option>
                    <option value="daily">Di√°rio</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Hor√°rio *</label>
                <input type="time" name="time" required value="02:00">
            </div>
            <div class="form-group" id="weekDay" style="display:none;">
                <label>Dia da Semana</label>
                <select name="day_of_week">
                    <option value="0">Segunda</option>
                    <option value="1">Ter√ßa</option>
                    <option value="2">Quarta</option>
                    <option value="3">Quinta</option>
                    <option value="4">Sexta</option>
                    <option value="5">S√°bado</option>
                    <option value="6">Domingo</option>
                </select>
            </div>
            <div class="form-group" id="monthDay" style="display:none;">
                <label>Dia do M√™s</label>
                <input type="number" name="day_of_month" min="1" max="31" value="1">
            </div>
            <button type="submit" class="btn btn-success">üíæ Criar</button>
        </form>
    </div>
</div>

<!-- Modal Editar -->
<div id="editScheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Agendamento</h2>
            <span class="close" onclick="closeModal('editScheduleModal')">&times;</span>
        </div>
        <form id="editScheduleForm">
            <input type="hidden" id="editScheduleId">
            <div class="form-group">
                <label>Dispositivo</label>
                <select id="editDeviceId">
                    <option value="">Todos os dispositivos</option>
                    {% for device in devices %}
                    {% if device.active %}
                    <option value="{{ device.id }}">{{ device.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Frequ√™ncia *</label>
                <select id="editFrequency" required onchange="updateEditFrequency()">
                    <option value="daily">Di√°rio</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Hor√°rio *</label>
                <input type="time" id="editTime" required>
            </div>
            <div class="form-group" id="editWeekDay" style="display:none;">
                <label>Dia da Semana</label>
                <select id="editDayOfWeek">
                    <option value="0">Segunda</option>
                    <option value="1">Ter√ßa</option>
                    <option value="2">Quarta</option>
                    <option value="3">Quinta</option>
                    <option value="4">Sexta</option>
                    <option value="5">S√°bado</option>
                    <option value="6">Domingo</option>
                </select>
            </div>
            <div class="form-group" id="editMonthDay" style="display:none;">
                <label>Dia do M√™s</label>
                <input type="number" id="editDayOfMonth" min="1" max="31">
            </div>
            <button type="submit" class="btn btn-success">üíæ Atualizar</button>
        </form>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
function updateFrequency() {
    const freq = document.getElementById('frequency').value;
    document.getElementById('weekDay').style.display = freq === 'weekly' ? 'block' : 'none';
    document.getElementById('monthDay').style.display = freq === 'monthly' ? 'block' : 'none';
}

function updateEditFrequency() {
    const freq = document.getElementById('editFrequency').value;
    document.getElementById('editWeekDay').style.display = freq === 'weekly' ? 'block' : 'none';
    document.getElementById('editMonthDay').style.display = freq === 'monthly' ? 'block' : 'none';
}

document.getElementById('addScheduleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
        const response = await fetch('/schedules/add', {method: 'POST', body: formData});
        const data = await response.json();
        if (data.success) {
            showAlert('Agendamento criado!', 'success');
            closeModal('addScheduleModal');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Erro: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro: ' + error.message, 'danger');
    }
});

async function editSchedule(id) {
    try {
        const response = await fetch('/schedules/' + id + '/get');
        const schedule = await response.json();
        document.getElementById('editScheduleId').value = schedule.id;
        document.getElementById('editDeviceId').value = schedule.device_id || '';
        document.getElementById('editFrequency').value = schedule.frequency;
        document.getElementById('editTime').value = schedule.time;
        if (schedule.day_of_week !== null) {
            document.getElementById('editDayOfWeek').value = schedule.day_of_week;
        }
        if (schedule.day_of_month !== null) {
            document.getElementById('editDayOfMonth').value = schedule.day_of_month;
        }
        updateEditFrequency();
        showModal('editScheduleModal');
    } catch (error) {
        showAlert('Erro: ' + error.message, 'danger');
    }
}

document.getElementById('editScheduleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editScheduleId').value;
    const data = {
        device_id: document.getElementById('editDeviceId').value || null,
        frequency: document.getElementById('editFrequency').value,
        time: document.getElementById('editTime').value,
        day_of_week: document.getElementById('editDayOfWeek').value || null,
        day_of_month: document.getElementById('editDayOfMonth').value || null
    };
    try {
        const response = await fetch('/schedules/' + id + '/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Agendamento atualizado!', 'success');
            closeModal('editScheduleModal');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Erro: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro: ' + error.message, 'danger');
    }
});

async function deleteSchedule(scheduleId) {
    if (!confirm('Remover este agendamento?')) return;
    try {
        const response = await fetch('/schedules/' + scheduleId, {method: 'DELETE'});
        const data = await response.json();
        if (data.success) {
            showAlert('Agendamento removido!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Erro: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
